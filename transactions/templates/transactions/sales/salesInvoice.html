{% extends 'dashboard/base.html' %}
{% load static %}
{% block title %} Sales Invoice {% endblock title %}
{% block content %}
<style>
#id_paymentMode {
    display: flex;       /* Layout children horizontally */
    flex-direction: row; /* Ensure they stay in a row */
    gap: 20px;           /* Adds space between the options */
}

/* Optional: Removes the default block behavior of the inner divs */
#id_paymentMode div {
    display: inline-block;
}
</style>
<script>

    ////////////////////// - Add new Product
    window.addEventListener('load', function () {
        var inputElement = document.getElementById('id_grossAmount');
        if (inputElement) {
            inputElement.readOnly = true;
        }
    })

    function addNewItem() {
        const tableBody = document.querySelector('#item-table');
        const totalForms = document.querySelector('#id_items-TOTAL_FORMS'); // Standard Django ID
        const currentCount = parseInt(totalForms.value);

        // Clone the first row
        const newRow = document.querySelector('#item-row').cloneNode(true);

        const rowTotalDisplay = newRow.querySelector('#row-total');
        rowTotalDisplay.innerText = '0.00';
        // Update the index in all attributes (name, id, for)
        const regex = new RegExp(`items-(\\d+)-`, 'g');
        newRow.innerHTML = newRow.innerHTML.replace(regex, `items-${currentCount}-`);
        // Clear values in the new row
        newRow.querySelectorAll('input, select').forEach(input => {
            input.value = '';
            if (input.type === 'checkbox') input.checked = false;
        });

        tableBody.appendChild(newRow);

        // Increment the management form count
        totalForms.value = currentCount + 1;
    }

    document.addEventListener('change', function (e) {

        // Check if the element changed was a product dropdown
        if (e.target && (e.target.name.includes('-quantity') ||
            e.target.name.includes('-price') ||
            e.target.name.includes('discount') ||
            e.target.name.includes('-DELETE'))) {
            calculateTotals();
        }

        // Check if the element changed was a product text
        if (e.target && e.target.name.includes('-product')) {

            let baseUrl = "{% url 'GetProduct' barCode='0' %}";
            const productId = e.target.value;
            const row = e.target.closest('tr');
            const nameInput = row.querySelector('input[name*="-productName"]');
            const priceInput = row.querySelector('input[name*="-price"]');
            let fetchURL = baseUrl.replace('0', productId);
            if (productId) {
                fetch(fetchURL)
                    .then(response => response.json())
                    .then(data => {
                        if (data.price) {
                            priceInput.value = data.price;
                            nameInput.value = data.name;
                        }
                    })
                    .catch(error => console.error('Error fetching price:', error));
                priceInput.value = '';
                nameInput.value = "Error - not found !!!!"
                calculateTotals();
            } else {
                priceInput.value = '';
                calculateTotals();
                return;
            }

        }

        if (e.target && e.target.name.includes('customer')) {

            if (document.getElementById('id_customer').value !== '') {

                document.getElementById('id_one_time_name').value = ''
                document.getElementById('id_one_time_name').readOnly = true
                document.getElementById('id_one_time_number').value = ''
                document.getElementById('id_one_time_number').readOnly = true

                let baseUrl = "{% url 'GetCustomer' pk='0' %}";
                let fetchURL = baseUrl.replace('0', e.target.value);
                if (e.target.value) {
                    fetch(fetchURL)
                        .then(response => response.json())
                        .then(data => {
                            if (data.name) {
                                document.getElementById("b-cust").innerHTML = "<b>" + data.name + "</b>";
                                document.getElementById("b-number").innerHTML = "<i>" + data.mobileNo + "</i>";
                            }
                        })
                        .catch(error => console.error('Error fetching price:', error)
                        );
                    document.getElementById("b-cust").innerHTML = "<b> Error - not found !!!!  </b>";
                    document.getElementById("b-number").innerHTML = "<i> - </i>";
                }

            } else {
                document.getElementById('id_one_time_name').readOnly = false
                document.getElementById('id_one_time_number').readOnly = false
                document.getElementById("b-cust").innerHTML = "<b> - </b>";
                document.getElementById("b-number").innerHTML = "<i> - </i>";

            }

        }

    });

    function calculateTotals() {
        let grandTotal = 0;

        document.querySelectorAll('#item-row').forEach(row => {
            const qtyInput = row.querySelector('input[name*="-quantity"]');
            const priceInput = row.querySelector('input[name*="-price"]');
            const delIndicator = row.querySelector('input[name*="-DELETE"]');
            const rowTotalDisplay = row.querySelector('#row-total');

            const qty = parseFloat(qtyInput.value) || 0;
            const price = parseFloat(priceInput.value) || 0;
            const total = qty * price;

            // Update the row total display
            if (delIndicator.checked == true) {
                rowTotalDisplay.innerText = '0.00';
            }
            else {
                rowTotalDisplay.innerText = total.toFixed(2);
                grandTotal += total;
            }

        });

        document.getElementById('id_grossAmount').value = grandTotal.toFixed(2);
        grandTotal -= document.getElementById('id_discount').value
        document.getElementById('net-pay').innerText = grandTotal.toFixed(2);
    }

</script>

<center>

    <form method="post" id="invoice-form">
        {% csrf_token %}
        {{ items.management_form }}
        {{ items.non_form_errors }}
        {% for hidden in form.hidden_fields %}
        {{ hidden }}
        {% endfor %}
        <table>
            <tr>
                <td colspan="8" style="text-align:center; padding: 5px;">
                    <h4> Invoice Details </h3>
                </td>
            </tr>
            {% for field in form %}
                {{ form.non_form_errors }}
                {% if forloop.counter0|divisibleby:2 %}
                    <tr>
                {% endif %}
                
                <td style="padding: 5px;"> <label><b>{{ field.label }}</b></label></td>
                <td style="padding: 5px;"> : </td>
                <td style="padding: 5px;">{{ field }}
                    {% for error in field.errors %}
                    <p style="color:red">{{ error }}</p>
                     {% endfor %}
                </td>
                <td style="padding: 5px;"> &nbsp; </td>
                
                {% if not forloop.counter0|divisibleby:2 %}
                </tr>
                {% endif %}
            
                {% if forloop.counter0 == 1 %}
                <tr>
                    <td colspan="4" style="text-align:center; padding: 5px;" id="b-cust"> </td>
                    <td colspan="4" style="text-align:center; padding: 5px;" id="b-number"> </td>
                </tr>
                {%endif%}

            {% endfor %}
           
        </table>
        <br>&nbsp;</br>
        <div id="item-formset">
            <table id="item-table" style="color: whitesmoke;">
                <thead style="background-color:#A8001A">
                    <tr>
                        <td colspan="6" align="center"><h6>Items</h6></th>
                    </tr>
                    <tr>
                        <th scope="col" style="text-align:center; padding: 5px;">Product</th>
                        <th scope="col" style="text-align:center;padding: 5px;">Name</th>
                        <th scope="col" style="text-align:center;padding: 5px;">Quantity</th>
                        <th scope="col" style="text-align:center;padding: 5px;">Unit Price</th>
                        <th scope="col" width="100px" style="text-align:center;padding: 5px;">Total</th>
                        <th scope="col" style="text-align:center; padding: 5px;">Delete</th>
                    
                    </tr>
                </thead>
                
                <tbody>
                                       
                    {% for item_form in items %}
                    {% if item_form.non_field_errors %}
                        <div class="alert alert-warning">
                            {% for error in item_form.non_field_errors %}
                                <strong>{{ error }}</strong>
                            {% endfor %}
                        </div>
                    {% endif %}
                    <tr id="item-row">
                        <td style="padding: 5px;">{{ item_form.product }}
                            {% if item_form.product.errors %}
                                <br>
                                <small style="color:red">{{ item_form.product.errors.0 }}</small>
                            {% endif %}
                        </td>
                        <td style="padding: 5px;">{{ item_form.productName }}</td>
                        <td style="padding: 5px;">{{ item_form.quantity }}
                            {% if item_form.quantity.errors %}
                                <br>
                                <small style="color:red">{{ item_form.quantity.errors.0 }}</small>
                            {% endif %}
                        </td>
                        <td style="padding: 5px;">{{ item_form.price }}
                            {% if item_form.price.errors %}
                                <br>
                                <small style="color:red">{{ item_form.price.errors.0 }}</small>
                            {% endif %}
                        </td>
                        <td style="text-align:center; color:#A8001A" padding: 5px;" id="row-total">0.00</td>
                        <td style="text-align:center; padding: 5px;">{{ item_form.DELETE }}</td>
                    </tr>

                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot>
                    <tr>
                        <td colspan="6">&nbsp;</td>
                    </tr>
                    <tr style="background-color:#A8001A">
                        <td colspan="2" style="text-align:right"><strong>Net Payable:</strong></td>
                        <td id="net-pay" style="text-align:right">0.00</td>
                        <td colspan="3" align="right"><image src="{% static 'transactions/images/newItem.png' %}" 
                                         onclick="addNewItem()" style="border-radius: 7px;" width="120px" height="35px" />
                        </td>
                    </tr>
                    <tr>
                        <td colspan="6">&nbsp;</td>
                    </tr>
                </tfoot>
            </table>
        </div>
        <button type="submit" class="btn btn-primary" >Save Invoice</button>
        <a href="{% url 'SalesInvoiceList'%}" class="btn btn-info ml-4">{{ BtnText }}</a>
    </form>
</center>
{% endblock content %}